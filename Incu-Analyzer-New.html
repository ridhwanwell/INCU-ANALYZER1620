<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>INCU Analyzer</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mqtt/4.3.7/mqtt.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            padding: 20px;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #fff;
            min-height: 100vh;
        }

        .title {
            text-align: center;
            font-size: 2.5em;
            margin-bottom: 30px;
            color: #fff;
            text-shadow: 0 0 10px rgba(52, 152, 219, 0.5);
            animation: glow 2s ease-in-out infinite alternate;
        }

        @keyframes glow {
            from { text-shadow: 0 0 10px rgba(52, 152, 219, 0.5); }
            to { text-shadow: 0 0 20px rgba(52, 152, 219, 0.8); }
        }

        .mqtt-status {
            text-align: center;
            margin-bottom: 20px;
            padding: 10px;
            border-radius: 5px;
            transition: all 0.3s ease;
        }

        .mqtt-status.connected {
            background: rgba(46, 204, 113, 0.2);
            color: #2ecc71;
        }

        .mqtt-status.disconnected {
            background: rgba(231, 76, 60, 0.2);
            color: #e74c3c;
        }

        .control-buttons {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .control-btn {
            padding: 15px 30px;
            font-size: 1.1em;
            border: none;
            border-radius: 8px;
            background: rgba(52, 152, 219, 0.8);
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .control-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
            background: rgba(52, 152, 219, 1);
        }

        .control-btn.active {
            background: rgba(46, 204, 113, 0.8);
            animation: pulse 1.5s infinite;
        }

        .control-btn.stop {
            background: rgba(231, 76, 60, 0.8);
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .input-container {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .input-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .input-group label {
            font-weight: bold;
            color: #fff;
        }

        .input-group input {
            padding: 10px;
            border: 2px solid rgba(52, 152, 219, 0.5);
            border-radius: 5px;
            font-size: 1em;
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            transition: all 0.3s ease;
        }

        .input-group input:focus {
            outline: none;
            border-color: rgba(52, 152, 219, 1);
            background: rgba(255, 255, 255, 0.2);
        }

        .timer-display {
            text-align: center;
            font-size: 3em;
            margin-bottom: 30px;
            color: #fff;
            text-shadow: 0 0 10px rgba(52, 152, 219, 0.5);
            font-family: 'Courier New', monospace;
        }

        .alarm-box {
            max-width: 800px;
            margin: 0 auto 30px;
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            text-align: center;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            border: 2px solid rgba(46, 204, 113, 0.5);
        }

        .alarm-box.alert {
            background: rgba(231, 76, 60, 0.3);
            border-color: rgba(231, 76, 60, 1);
            animation: alertPulse 1s infinite;
        }

        @keyframes alertPulse {
            0%, 100% { box-shadow: 0 4px 15px rgba(231, 76, 60, 0.5); }
            50% { box-shadow: 0 8px 30px rgba(231, 76, 60, 0.8); }
        }

        .alarm-box h3 {
            margin-bottom: 10px;
            color: #fff;
            font-size: 1.5em;
        }

        .alarm-message {
            font-size: 1.2em;
            color: #2ecc71;
        }

        .alarm-box.alert .alarm-message {
            color: #fff;
            font-weight: bold;
        }

        .battery-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
            max-width: 1200px;
            margin-left: auto;
            margin-right: auto;
        }

        .battery-box {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            text-align: center;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .battery-box:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        }

        .battery-box h4 {
            margin-bottom: 8px;
            color: #fff;
            font-size: 1em;
        }

        .battery-value {
            font-size: 1.3em;
            color: #2ecc71;
            font-weight: bold;
        }

        .battery-box.low {
            background: rgba(231, 76, 60, 0.3);
            border-color: rgba(231, 76, 60, 1);
        }

        .battery-box.low .battery-value {
            color: #e74c3c;
        }

        .sensor-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
            max-width: 1200px;
            margin-left: auto;
            margin-right: auto;
        }

        .sensor-box {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            text-align: center;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .sensor-box:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
            background: rgba(255, 255, 255, 0.15);
        }

        .sensor-box.updated {
            animation: highlight 1s ease-out;
        }

        .sensor-box.error {
            background: rgba(231, 76, 60, 0.3);
            border-color: rgba(231, 76, 60, 1);
            animation: errorBlink 1s infinite;
        }

        @keyframes errorBlink {
            0%, 100% { background: rgba(231, 76, 60, 0.3); }
            50% { background: rgba(231, 76, 60, 0.5); }
        }

        @keyframes highlight {
            0% { background: rgba(52, 152, 219, 0.3); }
            100% { background: rgba(255, 255, 255, 0.1); }
        }

        .sensor-box h3 {
            margin-bottom: 10px;
            color: #fff;
        }

        .sensor-value {
            font-size: 1.5em;
            color: #3498db;
            text-shadow: 0 0 5px rgba(52, 152, 219, 0.5);
            transition: all 0.3s ease;
        }

        .table-container {
            overflow-x: auto;
            margin-top: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .data-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            background: rgba(255, 255, 255, 0.1);
            min-width: 1200px;
        }

        .data-table th, .data-table td {
            padding: 12px 15px;
            text-align: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            white-space: nowrap;
        }

        .data-table th {
            background: rgba(52, 152, 219, 0.8);
            color: white;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .data-table tr {
            transition: all 0.3s ease;
        }

        .data-table tr:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .new-row {
            animation: fadeIn 0.5s ease-out;
        }
    </style>
</head>
<body>
    <h1 class="title">INCU Analyzer</h1>
    
    <div id="mqttStatus" class="mqtt-status disconnected">
        MQTT Status: Disconnected
    </div>
    
    <div class="control-buttons">
        <button id="saveBtn" class="control-btn">Play Saving Data</button>
        <button id="resetBtn" class="control-btn">Reset Data</button>
        <button id="exportBtn" class="control-btn">Export to Spreadsheet</button>
    </div>

    <div class="input-container">
        <div class="input-group">
            <label>Interval (seconds)</label>
            <input type="number" id="intervalInput" min="1" value="2">
        </div>
        <div class="input-group">
            <label>Timer (HH:MM:SS)</label>
            <input type="text" id="timerInput" placeholder="00:00:00" pattern="[0-9]{2}:[0-9]{2}:[0-9]{2}" value="00:01:00">
        </div>
    </div>

    <div class="timer-display" id="timerDisplay">00:00:00</div>

    <div class="alarm-box" id="alarmBox">
        <h3>🔔 System Status</h3>
        <div class="alarm-message" id="alarmMessage">All Systems Normal</div>
    </div>

    <h2 style="text-align: center; margin-bottom: 15px;">Battery Status</h2>
    <div class="battery-grid">
        <div class="battery-box" id="batteryMain">
            <h4>Central Unit</h4>
            <div class="battery-value" id="batteryMainValue">100%</div>
        </div>
        <div class="battery-box" id="batteryNode1">
            <h4>Node 1</h4>
            <div class="battery-value" id="batteryNode1Value">100%</div>
        </div>
        <div class="battery-box" id="batteryNode2">
            <h4>Node 2</h4>
            <div class="battery-value" id="batteryNode2Value">100%</div>
        </div>
        <div class="battery-box" id="batteryNode3">
            <h4>Node 3</h4>
            <div class="battery-value" id="batteryNode3Value">100%</div>
        </div>
        <div class="battery-box" id="batteryNode4">
            <h4>Node 4</h4>
            <div class="battery-value" id="batteryNode4Value">100%</div>
        </div>
    </div>

    <h2 style="text-align: center; margin-bottom: 15px;">Sensor Data</h2>
    <div class="sensor-grid">
        <div class="sensor-box" id="t1Box">
            <h3>T1</h3>
            <div class="sensor-value" id="t1Value">0.0 °C</div>
        </div>
        <div class="sensor-box" id="t2Box">
            <h3>T2</h3>
            <div class="sensor-value" id="t2Value">0.0 °C</div>
        </div>
        <div class="sensor-box" id="t3Box">
            <h3>T3</h3>
            <div class="sensor-value" id="t3Value">0.0 °C</div>
        </div>
        <div class="sensor-box" id="t4Box">
            <h3>T4</h3>
            <div class="sensor-value" id="t4Value">0.0 °C</div>
        </div>
        <div class="sensor-box" id="t5Box">
            <h3>T5</h3>
            <div class="sensor-value" id="t5Value">0.0 °C</div>
        </div>
        <div class="sensor-box" id="tmBox">
            <h3>TM</h3>
            <div class="sensor-value" id="tmValue">0.0 °C</div>
        </div>
        <div class="sensor-box" id="flowBox">
            <h3>Flow</h3>
            <div class="sensor-value" id="flowValue">0.0 m/s</div>
        </div>
        <div class="sensor-box" id="noiseBox">
            <h3>Noise</h3>
            <div class="sensor-value" id="noiseValue">0.0 dB</div>
        </div>
        <div class="sensor-box" id="rhBox">
            <h3>RH</h3>
            <div class="sensor-value" id="rhValue">0.0 %</div>
        </div>
    </div>

    <div class="table-container">
        <table class="data-table">
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Time</th>
                    <th>T1 (°C)</th>
                    <th>T2 (°C)</th>
                    <th>T3 (°C)</th>
                    <th>T4 (°C)</th>
                    <th>T5 (°C)</th>
                    <th>TM (°C)</th>
                    <th>Flow (m/s)</th>
                    <th>Noise (dB)</th>
                    <th>RH (%)</th>
                </tr>
            </thead>
            <tbody id="dataTableBody"></tbody>
        </table>
    </div>

    <script>
        // MQTT Configuration
        const options = {
            protocol: 'ws',
            hostname: 'broker.hivemq.com',
            port: 8000,
            path: '/mqtt',
            clean: true,
            connectTimeout: 4000,
            reconnectPeriod: 1000,
            clientId: 'incu_analyzer_' + Math.random().toString(16).substr(2, 8)
        };

        const client = mqtt.connect(options);
        const topic = 'incu/sensors';
        let isRecording = false;
        let timerInterval;
        let dataInterval;
        let remainingTime = 0;
        let tableData = [];
        let currentSensorData = {
            t1: 0, t2: 0, t3: 0, t4: 0, t5: 0, tm: 0,
            flow: 0, noise: 0, rh: 0,
            batteryMain: 100, batteryNode1: 100, batteryNode2: 100,
            batteryNode3: 100, batteryNode4: 100
        };

        // MQTT Connection handling
        client.on('connect', () => {
            console.log('Connected to MQTT broker');
            document.getElementById('mqttStatus').className = 'mqtt-status connected';
            document.getElementById('mqttStatus').textContent = 'MQTT Status: Connected';
            client.subscribe(topic, (err) => {
                if (!err) {
                    console.log('Subscribed to topic:', topic);
                }
            });
        });

        client.on('error', (error) => {
            console.error('MQTT Error:', error);
            document.getElementById('mqttStatus').className = 'mqtt-status disconnected';
            document.getElementById('mqttStatus').textContent = 'MQTT Status: Error - ' + error.message;
        });

        client.on('offline', () => {
            document.getElementById('mqttStatus').className = 'mqtt-status disconnected';
            document.getElementById('mqttStatus').textContent = 'MQTT Status: Offline';
        });

        client.on('message', (receivedTopic, message) => {
            try {
                const data = JSON.parse(message.toString());
                console.log('Received data:', data);
                
                // Update current sensor data
                currentSensorData = {
                    t1: data.t1 || 0,
                    t2: data.t2 || 0,
                    t3: data.t3 || 0,
                    t4: data.t4 || 0,
                    t5: data.t5 || 0,
                    tm: data.tm || 0,
                    flow: data.flow || 0,
                    noise: data.noise || 0,
                    rh: data.rh || 0,
                    batteryMain: data.batteryMain !== undefined ? data.batteryMain : 100,
                    batteryNode1: data.batteryNode1 !== undefined ? data.batteryNode1 : 100,
                    batteryNode2: data.batteryNode2 !== undefined ? data.batteryNode2 : 100,
                    batteryNode3: data.batteryNode3 !== undefined ? data.batteryNode3 : 100,
                    batteryNode4: data.batteryNode4 !== undefined ? data.batteryNode4 : 100
                };
                
                updateSensorValues(currentSensorData);
                updateBatteryValues(currentSensorData);
                checkAlarms(currentSensorData);
                highlightUpdatedValues();
            } catch (e) {
                console.error('Error parsing MQTT message:', e);
            }
        });

        function highlightUpdatedValues() {
            const boxes = document.querySelectorAll('.sensor-box');
            boxes.forEach(box => {
                if (!box.classList.contains('error')) {
                    box.classList.add('updated');
                    setTimeout(() => box.classList.remove('updated'), 1000);
                }
            });
        }

        function updateSensorValues(data) {
            document.getElementById('t1Value').textContent = `${data.t1.toFixed(1)} °C`;
            document.getElementById('t2Value').textContent = `${data.t2.toFixed(1)} °C`;
            document.getElementById('t3Value').textContent = `${data.t3.toFixed(1)} °C`;
            document.getElementById('t4Value').textContent = `${data.t4.toFixed(1)} °C`;
            document.getElementById('t5Value').textContent = `${data.t5.toFixed(1)} °C`;
            document.getElementById('tmValue').textContent = `${data.tm.toFixed(1)} °C`;
            document.getElementById('flowValue').textContent = `${data.flow.toFixed(1)} m/s`;
            document.getElementById('noiseValue').textContent = `${data.noise.toFixed(1)} dB`;
            document.getElementById('rhValue').textContent = `${data.rh.toFixed(1)} %`;
        }

        function updateBatteryValues(data) {
            updateBatteryBox('batteryMain', 'batteryMainValue', data.batteryMain);
            updateBatteryBox('batteryNode1', 'batteryNode1Value', data.batteryNode1);
            updateBatteryBox('batteryNode2', 'batteryNode2Value', data.batteryNode2);
            updateBatteryBox('batteryNode3', 'batteryNode3Value', data.batteryNode3);
            updateBatteryBox('batteryNode4', 'batteryNode4Value', data.batteryNode4);
        }

        function updateBatteryBox(boxId, valueId, batteryLevel) {
            const box = document.getElementById(boxId);
            const valueEl = document.getElementById(valueId);
            valueEl.textContent = `${batteryLevel.toFixed(0)}%`;
            
            if (batteryLevel < 20) {
                box.classList.add('low');
            } else {
                box.classList.remove('low');
            }
        }

        function checkAlarms(data) {
            const temps = [data.t1, data.t2, data.t3, data.t4, data.t5];
            const alarmBox = document.getElementById('alarmBox');
            const alarmMessage = document.getElementById('alarmMessage');
            let hasError = false;
            let errorMessages = [];

            // Reset all sensor boxes
            ['t1Box', 't2Box', 't3Box', 't4Box', 't5Box'].forEach(id => {
                document.getElementById(id).classList.remove('error');
            });

            // Check temperature differences
            for (let i = 0; i < temps.length; i++) {
                for (let j = i + 1; j < temps.length; j++) {
                    const diff = Math.abs(temps[i] - temps[j]);
                    if (diff >= 2.0) {
                        hasError = true;
                        const sensorNames = ['T1', 'T2', 'T3', 'T4', 'T5'];
                        errorMessages.push(`${sensorNames[i]} and ${sensorNames[j]}: ${diff.toFixed(1)}°C difference`);
                        document.getElementById(`t${i+1}Box`).classList.add('error');
                        document.getElementById(`t${j+1}Box`).classList.add('error');
                    }
                }
            }

            // Check for sensor failures (values stuck at 0 or unrealistic)
            temps.forEach((temp, index) => {
                if (temp === 0 && isRecording) {
                    hasError = true;
                    errorMessages.push(`T${index+1}: Sensor failure detected`);
                    document.getElementById(`t${index+1}Box`).classList.add('error');
                }
            });

            // Update alarm display
            if (hasError) {
                alarmBox.classList.add('alert');
                alarmMessage.textContent = '⚠️ ALARM: ' + errorMessages.join(' | ');
            } else {
                alarmBox.classList.remove('alert');
                alarmMessage.textContent = '✓ All Systems Normal';
            }
        }

        function addTableRow(data) {
            const now = new Date();
            const row = {
                date: now.toLocaleDateString('id-ID'),
                time: now.toLocaleTimeString('id-ID'),
                ...data
            };
            tableData.push(row);
            
            const tbody = document.getElementById('dataTableBody');
            const tr = document.createElement('tr');
            tr.classList.add('new-row');
            tr.innerHTML = `
                <td>${row.date}</td>
                <td>${row.time}</td>
                <td>${row.t1.toFixed(1)}</td>
                <td>${row.t2.toFixed(1)}</td>
                <td>${row.t3.toFixed(1)}</td>
                <td>${row.t4.toFixed(1)}</td>
                <td>${row.t5.toFixed(1)}</td>
                <td>${row.tm.toFixed(1)}</td>
                <td>${row.flow.toFixed(1)}</td>
                <td>${row.noise.toFixed(1)}</td>
                <td>${row.rh.toFixed(1)}</td>
            `;
            tbody.appendChild(tr);
        }

        function parseTimer(timeString) {
            const parts = timeString.split(':');
            if (parts.length !== 3) return 0;
            const hours = parseInt(parts[0]) || 0;
            const minutes = parseInt(parts[1]) || 0;
            const seconds = parseInt(parts[2]) || 0;
            return hours * 3600 + minutes * 60 + seconds;
        }

        function formatTime(seconds) {
            const h = Math.floor(seconds / 3600);
            const m = Math.floor((seconds % 3600) / 60);
            const s = seconds % 60;
            return `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;
        }

        function updateTimerDisplay() {
            document.getElementById('timerDisplay').textContent = formatTime(remainingTime);
        }

        function startRecording() {
            const timerInput = document.getElementById('timerInput').value;
            const intervalSeconds = parseInt(document.getElementById('intervalInput').value) || 2;
            
            remainingTime = parseTimer(timerInput);
            
            if (remainingTime <= 0) {
                alert('Please enter a valid timer duration (HH:MM:SS)');
                return;
            }

            isRecording = true;
            const saveBtn = document.getElementById('saveBtn');
            saveBtn.textContent = 'Stop Saving Data';
            saveBtn.classList.add('active', 'stop');

            updateTimerDisplay();

            // Timer countdown
            timerInterval = setInterval(() => {
                remainingTime--;
                updateTimerDisplay();

                if (remainingTime <= 0) {
                    stopRecording();
                }
            }, 1000);

            // Data recording at specified interval
            dataInterval = setInterval(() => {
                if (isRecording) {
                    addTableRow(currentSensorData);
                }
            }, intervalSeconds * 1000);
        }

        function stopRecording() {
            isRecording = false;
            clearInterval(timerInterval);
            clearInterval(dataInterval);
            
            const saveBtn = document.getElementById('saveBtn');
            saveBtn.textContent = 'Play Saving Data';
            saveBtn.classList.remove('active', 'stop');
            
            remainingTime = 0;
            updateTimerDisplay();
        }

        // Button event listeners
        document.getElementById('saveBtn').addEventListener('click', () => {
            if (isRecording) {
                stopRecording();
            } else {
                startRecording();
            }
        });

        document.getElementById('resetBtn').addEventListener('click', () => {
            if (confirm('Are you sure you want to reset all data?')) {
                tableData = [];
                document.getElementById('dataTableBody').innerHTML = '';
                stopRecording();
                console.log('Data reset');
            }
        });

        document.getElementById('exportBtn').addEventListener('click', () => {
            if (tableData.length === 0) {
                alert('No data to export!');
                return;
            }

            try {
                // Prepare data for export
                const exportData = tableData.map(row => ({
                    'Date': row.date,
                    'Time': row.time,
                    'T1 (°C)': row.t1.toFixed(1),
                    'T2 (°C)': row.t2.toFixed(1),
                    'T3 (°C)': row.t3.toFixed(1),
                    'T4 (°C)': row.t4.toFixed(1),
                    'T5 (°C)': row.t5.toFixed(1),
                    'TM (°C)': row.tm.toFixed(1),
                    'Flow (m/s)': row.flow.toFixed(1),
                    'Noise (dB)': row.noise.toFixed(1),
                    'RH (%)': row.rh.toFixed(1)
                }));

                // Create worksheet
                const ws = XLSX.utils.json_to_sheet(exportData);
                
                // Set column widths
                ws['!cols'] = [
                    {wch: 12}, {wch
